<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åœ¨çº¿è€ƒè¯• - ç­”é¢˜ä¸­</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <style>
        body { background: #f5f7fa; padding: 20px; font-family: "Helvetica Neue", Helvetica, "PingFang SC", Arial, sans-serif; }

        /* å¸ƒå±€å®¹å™¨ï¼šæ”¹ä¸º Flex å¸ƒå±€ä»¥å®¹çº³ä¾§è¾¹æ  */
        .main-wrapper { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; align-items: flex-start; }

        /* å·¦ä¾§ç­”é¢˜å¡ (æ–°å¢) */
        .side-card {
            width: 280px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: sticky;
            top: 20px; /* æ‚¬æµ®å›ºå®š */
        }
        .card-title { font-weight: bold; margin-bottom: 15px; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .q-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .q-num {
            width: 36px; height: 36px; line-height: 36px; text-align: center;
            border-radius: 4px; background: #f4f4f5; color: #909399; cursor: pointer;
            font-size: 14px; transition: 0.2s; border: 1px solid #e9e9eb;
        }
        .q-num:hover { border-color: #409EFF; color: #409EFF; }
        .q-num.done { background: #409EFF; color: white; border-color: #409EFF; } /* å·²åšå˜è“ */
        .q-num.current { box-shadow: 0 0 0 2px #a0cfff; }

        /* å³ä¾§è¯•å·ä¸»ä½“ */
        .exam-container { flex: 1; background: white; min-height: 800px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); border-radius: 8px; display: flex; flex-direction: column; }

        /* å¤´éƒ¨æ ·å¼ */
        .exam-header { padding: 30px; border-bottom: 1px solid #eee; text-align: center; background: #fafafa; border-radius: 8px 8px 0 0; }
        .exam-title { font-size: 24px; font-weight: bold; color: #303133; margin-bottom: 10px; }
        .exam-meta { color: #909399; font-size: 14px; display: flex; justify-content: center; gap: 20px; }

        /* é¢˜ç›®ä¸»ä½“ */
        .exam-body { padding: 40px; flex: 1; }
        .q-item { margin-bottom: 40px; border-bottom: 1px dashed #f0f0f0; padding-bottom: 30px; scroll-margin-top: 20px; } /* scroll-margin ä¼˜åŒ–è·³è½¬ä½ç½® */
        .q-title { font-size: 17px; font-weight: 600; margin-bottom: 20px; line-height: 1.6; color: #303133; }
        .q-tag { margin-right: 8px; vertical-align: text-bottom; }

        /* é€‰é¡¹æ ·å¼ */
        .option-group { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .option-item {
            width: 100%;
            height: auto !important;
            padding: 15px 20px !important;
            border: 1px solid #dcdfe6;
            border-radius: 6px;
            white-space: normal !important;
            transition: all 0.2s;
            margin: 0 !important;
            display: flex !important;
            align-items: flex-start;
        }
        .option-item:hover { background-color: #f0f9eb; border-color: #67c23a; }
        .option-item.is-checked { border-color: #409EFF; background-color: #ecf5ff; }
        .el-radio__label { white-space: normal !important; line-height: 1.6; display: inline-block; width: 100%; }

        /* åº•éƒ¨æŒ‰é’® */
        .footer { padding: 20px 40px; border-top: 1px solid #eee; text-align: center; position: sticky; bottom: 0; background: white; z-index: 99; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); }

        /* é˜²ä½œå¼Šè­¦å‘Šæ¡ */
        .cheat-alert {
            position: fixed; top: 0; left: 0; right: 0;
            background: #F56C6C; color: white; text-align: center;
            padding: 10px; z-index: 9999; font-weight: bold;
            display: none; /* é»˜è®¤éšè— */
        }
    </style>
</head>
<body>
<div id="app">
    <div class="cheat-alert" v-show="switchCount > 0">
        âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°åˆ‡å±è¡Œä¸ºï¼å½“å‰æ¬¡æ•°ï¼š{{ switchCount }}/3ã€‚è¶…è¿‡3æ¬¡å°†è‡ªåŠ¨äº¤å·ï¼
    </div>

    <div class="main-wrapper" v-loading="loading">

        <div class="side-card">
            <div class="card-title">
                ç­”é¢˜å¡
                <span style="font-size: 12px; font-weight: normal; color: #666; float: right;">
                    å·²åš <span style="color:#409EFF; font-weight:bold">{{ answeredCount }}</span> / {{ questions.length }}
                </span>
            </div>
            <div class="q-grid">
                <div v-for="(q, index) in questions" :key="q.id"
                     class="q-num"
                     :class="{ done: hasAnswered(q.id) }"
                     @click="scrollToQuestion(index)">
                    {{ index + 1 }}
                </div>
            </div>
            <div style="margin-top: 20px; font-size: 12px; color: #999; line-height: 1.5;">
                <p>ğŸŸ¦ è“è‰²ï¼šå·²ä½œç­”</p>
                <p>â¬œ ç°è‰²ï¼šæœªä½œç­”</p>
                <div style="border-top: 1px dashed #eee; margin: 10px 0;"></div>
                <p style="color: #F56C6C;">âš ï¸ æ³¨æ„ï¼šåˆ‡å±è¶…è¿‡3æ¬¡æˆ–ç¦»å¼€é¡µé¢è¶…è¿‡10ç§’å°†å¼ºåˆ¶äº¤å·ï¼</p>
            </div>
        </div>

        <div class="exam-container">
            <div class="exam-header">
                <div class="exam-title">{{ paper.title || 'æ­£åœ¨åŠ è½½è¯•å·...' }}</div>
                <div class="exam-meta" v-if="paper.id">
                    <span><el-icon><Timer /></el-icon> è€ƒè¯•æ—¶é•¿ï¼š{{ paper.duration }} åˆ†é’Ÿ</span>
                    <span><el-icon><Trophy /></el-icon> å·é¢æ€»åˆ†ï¼š{{ paper.totalScore }} åˆ†</span>
                </div>
            </div>

            <div class="exam-body">
                <div v-for="(q, index) in questions" :key="q.id" :id="'q-'+index" class="q-item">
                    <div class="q-title">
                        <el-tag class="q-tag" effect="dark" :type="getTypeColor(q.type)">{{ getTypeLabel(q.type) }}</el-tag>
                        <span style="margin-right: 5px;">{{ index + 1 }}.</span>
                        <span v-html="formatText(q.title)"></span>
                        <span style="color:#999;font-size:13px;font-weight:normal;margin-left:8px">({{ q.score }}åˆ†)</span>
                    </div>

                    <div v-if="q.type === 3">
                        <el-radio-group v-model="answers[q.id]">
                            <el-radio label="æ­£ç¡®" border>âœ… æ­£ç¡®</el-radio>
                            <el-radio label="é”™è¯¯" border>âŒ é”™è¯¯</el-radio>
                        </el-radio-group>
                    </div>

                    <div v-else-if="q.type === 1 || q.type === 2">
                        <el-radio-group v-model="answers[q.id]" class="option-group">
                            <el-radio v-for="(opt, idx) in parseOptions(q.options)"
                                      :key="idx"
                                      :label="opt.label"
                                      class="option-item"
                                      border>
                                <span style="font-weight: bold; color: #409EFF; margin-right: 10px;">{{ opt.label }}.</span>
                                <span v-html="formatText(opt.text)"></span>
                            </el-radio>
                        </el-radio-group>
                    </div>

                    <div v-else>
                        <el-input
                                v-model="answers[q.id]"
                                type="textarea"
                                :rows="5"
                                placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„ç­”æ¡ˆ..."
                                maxlength="2000"
                                show-word-limit>
                        </el-input>
                    </div>
                </div>
            </div>

            <div class="footer">
                <el-button type="primary" size="large" @click="submitByUser" :loading="submitting" style="width: 240px; font-weight: bold; letter-spacing: 2px;">
                    äº¤ å·
                </el-button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
<script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref, onMounted, computed, onBeforeUnmount } = Vue;
    const { ElMessage, ElMessageBox, ElNotification } = ElementPlus;

    const app = createApp({
        setup() {
            const loading = ref(true);
            const submitting = ref(false);
            const paper = ref({});
            const questions = ref([]);
            const answers = ref({});

            // é˜²ä½œå¼Šå˜é‡
            const switchCount = ref(0);
            const maxSwitch = 3;
            let awayTimer = null;

            const paperId = new URLSearchParams(location.search).get('id');

            // ç»Ÿè®¡å·²åšæ•°é‡
            const answeredCount = computed(() => {
                let count = 0;
                for (let k in answers.value) {
                    if (answers.value[k] && answers.value[k].trim() !== '') count++;
                }
                return count;
            });

            // åˆ¤æ–­æŸé¢˜æ˜¯å¦å·²åš
            const hasAnswered = (qid) => {
                return answers.value[qid] && answers.value[qid].length > 0;
            };

            // è·³è½¬åˆ°é¢˜ç›®
            const scrollToQuestion = (index) => {
                const el = document.getElementById('q-' + index);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };

            // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒï¼šé˜²ä½œå¼Šé€»è¾‘ ğŸ”¥ğŸ”¥ğŸ”¥
            const initAntiCheat = () => {
                // 1. ç›‘å¬åˆ‡å± (visibilitychange)
                document.addEventListener("visibilitychange", () => {
                    if (document.hidden) {
                        handleSwitchScreen();
                    }
                });

                // 2. ç›‘å¬å¤±å»ç„¦ç‚¹ (Blur) - æ¯”å¦‚åˆ‡åˆ°QQèŠå¤©çª—å£
                window.addEventListener("blur", () => {
                    handleSwitchScreen();
                    // å¼€å§‹10ç§’å€’è®¡æ—¶
                    awayTimer = setTimeout(() => {
                        forceSubmit("é•¿æ—¶é—´ç¦»å¼€é¡µé¢ï¼ˆè¶…è¿‡10ç§’ï¼‰");
                    }, 10000); // 10ç§’
                });

                // 3. ç›‘å¬è·å¾—ç„¦ç‚¹ (Focus) - å›æ¥äº†
                window.addEventListener("focus", () => {
                    if (awayTimer) {
                        clearTimeout(awayTimer); // å¦‚æœ10ç§’å†…å›æ¥äº†ï¼Œæ¸…é™¤å®šæ—¶å™¨
                        awayTimer = null;
                    }
                });
            };

            const handleSwitchScreen = () => {
                if (submitting.value) return; // æ­£åœ¨äº¤å·ä¸­å°±ä¸ç®¡äº†

                switchCount.value++;
                const left = maxSwitch - switchCount.value;

                if (left < 0) {
                    forceSubmit("åˆ‡å±æ¬¡æ•°è¿‡å¤š");
                } else {
                    ElMessage.warning({
                        message: `æ£€æµ‹åˆ°åˆ‡å±ï¼ä½ è¿˜æœ‰ ${left} æ¬¡æœºä¼šï¼Œä¹‹åå°†å¼ºåˆ¶äº¤å·ï¼`,
                        duration: 5000,
                        showClose: true
                    });
                }
            };

            const forceSubmit = (reason) => {
                if (submitting.value) return;

                ElMessageBox.alert(`ç›‘æµ‹åˆ°è¿è§„è¡Œä¸ºï¼š${reason}ï¼Œç³»ç»Ÿå·²å¼ºåˆ¶äº¤å·ã€‚`, 'è€ƒè¯•ç»ˆæ­¢', {
                    confirmButtonText: 'ç¡®å®š',
                    type: 'error',
                    showClose: false,
                    callback: () => {
                        doSubmit();
                    }
                });
                doSubmit(); // å³ä½¿ä¸ç‚¹ç¡®å®šï¼Œåå°ä¹Ÿç›´æ¥å‘è¯·æ±‚
            };

            const doSubmit = () => {
                submitting.value = true;
                axios.post('/api/student/exam/submit', {
                    paperId: parseInt(paperId),
                    answers: answers.value
                }).then(res => {
                    if (res.data.code === 200) {
                        location.href = 'result.html?id=' + res.data.data;
                    } else {
                        ElMessage.error('æäº¤å¤±è´¥ï¼Œè¯·è”ç³»ç›‘è€ƒè€å¸ˆï¼');
                    }
                });
            };

            // åŠ è½½æ•°æ®
            const loadData = () => {
                if (!paperId) { ElMessage.error('è¯•å·IDå‚æ•°ç¼ºå¤±ï¼'); loading.value = false; return; }
                axios.get('/api/student/paper/' + paperId).then(res => {
                    if (res.data.code === 200) {
                        paper.value = res.data.data.paper;
                        questions.value = res.data.data.questions;
                        initAntiCheat(); // æ•°æ®åŠ è½½å®Œæ‰å¯åŠ¨é˜²ä½œå¼Š
                    } else {
                        ElMessage.error(res.data.msg || 'è¯•å·åŠ è½½å¤±è´¥');
                    }
                }).finally(() => { loading.value = false; });
            };

            // ç”¨æˆ·ä¸»åŠ¨äº¤å·
            const submitByUser = () => {
                const unAnswered = questions.value.length - answeredCount.value;
                let msg = 'ç¡®å®šè¦ç°åœ¨äº¤å·å—ï¼Ÿ';
                if (unAnswered > 0) {
                    msg = `ä½ è¿˜æœ‰ ${unAnswered} é“é¢˜æ²¡åšï¼ˆè¯·çœ‹å·¦ä¾§ç°è‰²é¢˜å·ï¼‰ï¼Œç¡®å®šè¦äº¤å·å—ï¼Ÿ`;
                }

                ElMessageBox.confirm(msg, 'äº¤å·ç¡®è®¤', {
                    confirmButtonText: 'ç‹ å¿ƒäº¤å·',
                    cancelButtonText: 'æˆ‘å†æ£€æŸ¥ä¸‹',
                    type: 'warning'
                }).then(() => {
                    doSubmit();
                });
            };

            // è¾…åŠ©å‡½æ•°
            const parseOptions = (optionStr) => {
                if (!optionStr) return [];
                try {
                    let opts = JSON.parse(optionStr);
                    if (Array.isArray(opts) && opts.length > 0 && opts[0].label) return opts;
                    if (Array.isArray(opts)) {
                        const labels = ['A','B','C','D','E','F'];
                        return opts.map((text, idx) => {
                            let str = String(text).trim();
                            let label = labels[idx] || '?';
                            const match = str.match(/^([A-Z])[\.\ã€\s]\s*(.*)/);
                            if (match) { label = match[1]; str = match[2]; }
                            return { label: label, text: str };
                        });
                    }
                    if (typeof opts === 'object') return Object.keys(opts).map(k => ({ label: k, text: opts[k] }));
                    return [];
                } catch (e) { return []; }
            };
            const formatText = (text) => text ? text.replace(/\n/g, '<br>') : '';
            const getTypeColor = (t) => t===1?'primary':(t===2?'success':(t===3?'warning':(t===4?'info':'danger')));
            const getTypeLabel = (t) => ({1:'å•é€‰é¢˜', 2:'å¤šé€‰é¢˜', 3:'åˆ¤æ–­é¢˜', 4:'å¡«ç©ºé¢˜', 5:'ç®€ç­”é¢˜'}[t] || 'å…¶ä»–');

            onMounted(loadData);
            return {
                paper, questions, answers, loading, submitting, switchCount, answeredCount,
                submitByUser, parseOptions, formatText, getTypeColor, getTypeLabel,
                hasAnswered, scrollToQuestion
            };
        }
    });
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) app.component(key, component);
    app.use(ElementPlus);
    app.mount('#app');
</script>
</body>
</html>