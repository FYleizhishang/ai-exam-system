<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ•™å¸ˆå·¥ä½œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="layout.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body style="padding-top: 80px;">
<div class="navbar-mac">
    <div class="fw-bold fs-5 text-primary">ğŸ‘¨â€ğŸ« æ•™å¸ˆé˜…å·ä¸­å¿ƒ</div>
    <button class="btn btn-sm btn-outline-danger" onclick="location.href='/dashboard.html'">è¿”å›ä¸»é¡µ</button>
</div>

<div class="container py-4">
    <div id="view-list">
        <h4 class="fw-bold mb-4">ğŸ“„ å¾…æ‰¹æ”¹è¯•å·</h4>
        <div id="paperList" class="row g-3"></div>
    </div>

    <div id="view-grade" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-light" onclick="back()">â† è¿”å›</button>
            <h4 class="fw-bold">æ­£åœ¨æ‰¹æ”¹: <span id="curStu" class="text-primary">--</span></h4>
            <button class="btn btn-primary px-4" onclick="submitGrade()">âœ… æäº¤æˆç»©</button>
        </div>
        <div class="mac-card"><div id="gradeArea"></div></div>
    </div>
</div>

<script>
    let curId = null, curDetails = [];
    function loadList() {
        fetch('/api/exam/pending-list').then(r=>r.json()).then(d => {
            if(d.length===0) return document.getElementById('paperList').innerHTML = `<div class="text-center text-muted py-5">æš‚æ— è¯•å·</div>`;
            document.getElementById('paperList').innerHTML = d.map(p => `
                <div class="col-md-4"><div class="mac-card d-flex justify-content-between align-items-center">
                    <div><h5 class="fw-bold mb-1">${p.studentName}</h5><small class="text-muted">AIè¯„åˆ†: ${p.score}</small></div>
                    <button class="btn btn-primary btn-sm rounded-pill" onclick="start(${p.id},'${p.studentName}')">æ‰¹æ”¹</button>
                </div></div>`).join('');
        });
    }
    window.start = function(id, name) {
        curId = id; document.getElementById('curStu').innerText = name;
        document.getElementById('view-list').style.display='none'; document.getElementById('view-grade').style.display='block';
        fetch(`/api/exam/detail?id=${id}`).then(r=>r.json()).then(d => { curDetails = JSON.parse(d.details); render(); });
    }
    function render() {
        document.getElementById('gradeArea').innerHTML = curDetails.map((q, i) => `
            <div class="border-bottom py-3">
                <div class="d-flex justify-content-between"><h6>${i+1}. ${q.title}</h6><span class="badge bg-secondary">æ»¡åˆ†: ${q.fullScore}</span></div>
                <div class="bg-light p-2 rounded mb-2"><small>å­¦ç”Ÿ:</small> <strong>${q.stuAns||'æœªä½œç­”'}</strong></div>
                <div class="d-flex align-items-center gap-2">
                    <small>è€å¸ˆç»™åˆ†:</small>
                    <input type="number" class="form-control form-control-sm" style="width:80px" value="${q.getScore}" onchange="curDetails[${i}].getScore=parseInt(this.value)">
                </div>
            </div>`).join('');
    }
    window.submitGrade = function() {
        fetch('/api/exam/grade', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:curId,details:curDetails})})
            .then(()=>{ Swal.fire('æˆåŠŸ','æˆç»©å·²å‘å¸ƒ','success'); back(); loadList(); });
    }
    window.back = function(){document.getElementById('view-list').style.display='block'; document.getElementById('view-grade').style.display='none';}
    loadList();
</script>
</body>
</html>