<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>iStudy æ™ºèƒ½æ•™åŠ¡ä¸­å°</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        /* é˜²æ­¢æœªåŠ è½½å®Œæ—¶æ˜¾ç¤ºä¹±ç  */
        [v-cloak] { display: none; }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang SC', sans-serif; background: #f5f7fa; }
        .app-container { height: 100vh; display: flex; flex-direction: column; }
        .header { background: #fff; height: 60px; padding: 0 20px; display: flex; align-items: center; border-bottom: 1px solid #dcdfe6; flex-shrink: 0; }

        .main-content { flex: 1; padding: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .el-tabs--border-card { flex: 1; display: flex; flex-direction: column; overflow: hidden; border: none; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1); }
        .el-tabs__header { margin-bottom: 0 !important; flex-shrink: 0; }
        .el-tabs__content { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }

        .repo-container { display: flex; height: 100%; gap: 20px; }
        .repo-sidebar { width: 220px; background: white; border-radius: 8px; border: 1px solid #ebeef5; padding: 10px; overflow-y: auto; flex-shrink: 0; }
        .repo-main { flex: 1; background: white; border-radius: 8px; border: 1px solid #ebeef5; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }

        .subject-item { padding: 12px; cursor: pointer; border-radius: 4px; transition: 0.2s; color: #606266; display: flex; justify-content: space-between; align-items: center; }
        .subject-item:hover { background: #ecf5ff; color: #409EFF; }
        .subject-item.active { background: #409EFF; color: white; font-weight: bold; }
        .del-subject-btn { display: none; color: #F56C6C; font-size: 12px; }
        .subject-item:hover .del-subject-btn { display: block; }

        .q-card { background: #fff; border: 1px solid #ebeef5; padding: 20px; margin-bottom: 15px; border-radius: 8px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.3s; }
        .q-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .q-del-btn { position: absolute; top: 10px; right: 10px; display: none; }
        .q-card:hover .q-del-btn { display: block; }

        .type-tag { font-weight: bold; margin-right: 8px; }

        /* é¢„è§ˆåˆ—è¡¨æ ·å¼ */
        .preview-list { max-height: 500px; overflow-y: auto; padding: 10px; border: 1px solid #ebeef5; border-radius: 4px; }
        .preview-item { padding: 10px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; }
        .preview-item:last-child { border-bottom: none; }

        /* åŠ¨ç”»æ—¥å¿—æ¡† */
        .hologram-box {
            background-color: #0d1117;
            color: #58a6ff;
            font-family: 'Consolas', monospace;
            padding: 20px;
            border-radius: 8px;
            height: 350px;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid #30363d;
            box-shadow: 0 0 20px rgba(88, 166, 255, 0.2);
        }
        .hologram-box::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: #58a6ff;
            opacity: 0.6;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 8px #58a6ff;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .log-container { flex: 1; overflow-y: auto; margin-top: 15px; font-size: 13px; line-height: 1.8; }
        .log-line { border-left: 2px solid #238636; padding-left: 10px; margin-bottom: 5px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .status-header { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        .spinner { width: 16px; height: 16px; border: 2px solid #58a6ff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ä¼˜åŒ–è¿é€‰ä½“éªŒ */
        .no-select { user-select: none; }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div class="app-container">
        <div class="header">
            <h2 style="color: #409EFF; display: flex; align-items: center; gap: 10px; margin: 0;">
                <el-icon><Monitor /></el-icon> iStudy æ™ºèƒ½æ•™åŠ¡ä¸­å°
            </h2>
            <div style="flex: 1"></div>
            <el-button type="danger" plain size="small" @click="logout">é€€å‡º</el-button>
        </div>

        <div class="main-content">
            <el-tabs v-model="activeTab" type="border-card">

                <el-tab-pane name="gen">
                    <template #label><span style="display: flex; align-items: center; gap:5px"><el-icon><Cpu /></el-icon> AI æ™ºèƒ½å‡ºé¢˜</span></template>
                    <div style="max-width: 900px; margin: 0 auto;">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; position: sticky; top: 0; z-index: 10; background: #fff; padding-bottom: 10px;">
                            <el-select v-model="difficulty" style="width: 120px;" placeholder="éš¾åº¦">
                                <el-option label="ç®€å•" value="ç®€å•"></el-option>
                                <el-option label="ä¸­ç­‰" value="ä¸­ç­‰"></el-option>
                                <el-option label="å›°éš¾" value="å›°éš¾"></el-option>
                            </el-select>
                            <el-input v-model="command" placeholder="ä¾‹ï¼šç”Ÿæˆæ•°æ®åº“å·å­ï¼Œçœ‹ç€åŠ" size="large" @keyup.enter="generate">
                                <template #prepend>AI æŒ‡ä»¤</template>
                            </el-input>
                            <el-button type="primary" size="large" @click="generate" :loading="loading">ç”Ÿæˆ</el-button>
                        </div>

                        <div v-if="paper.length > 0">
                            <div style="background: #fdf6ec; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <div><span style="font-weight: bold; color: #E6A23C;">AI æ‹Ÿé¢˜ï¼š</span><el-input v-model="paperTitle" style="width: 300px;"></el-input></div>
                                <el-button type="success" icon="Check" @click="publishAI">ç¡®è®¤å…¥åº“</el-button>
                            </div>

                            <div v-for="(q, i) in paper" :key="i" class="q-card">
                                <el-button type="danger" icon="Delete" circle size="small" class="q-del-btn" @click="removeAiQuestion(i)"></el-button>
                                <div style="margin-bottom: 10px; display: flex; align-items: center;">
                                    <el-tag :type="getTypeTag(q.type)">{{ getTypeName(q.type) }}</el-tag>
                                    <el-tag type="warning" effect="plain" style="margin-right: 8px;">éš¾åº¦: {{ q.difficulty || 3 }}æ˜Ÿ</el-tag>
                                    <span style="font-size: 12px; color: #999;">(å¾…é…åˆ†)</span>
                                </div>
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">{{ q.title }}</div>
                                <div style="font-size: 13px; color: #909399; background: #fafafa; padding: 10px; border-radius: 4px;">
                                    <div style="margin-bottom: 8px; color: #67C23A;"><b>âœ… å‚è€ƒç­”æ¡ˆï¼š</b>{{ q.answer }}</div>
                                    <div style="color: #909399;"><b>ğŸ“– è¯¦ç»†è§£æï¼š</b>{{ q.analysis || 'æš‚æ— è§£æ' }}</div>
                                </div>
                            </div>
                            <div style="height: 50px;"></div>
                        </div>
                        <el-empty v-else description="è¾“å…¥æŒ‡ä»¤ï¼Œå¬å”¤ DeepSeek å‡ºé¢˜..." :image-size="150"></el-empty>
                    </div>
                </el-tab-pane>

                <el-tab-pane name="repo">
                    <template #label><span style="display: flex; align-items: center; gap:5px"><el-icon><Files /></el-icon> é¢˜åº“ä¸ç»„å·</span></template>
                    <div class="repo-container">
                        <div class="repo-sidebar">
                            <div style="padding: 10px; font-weight: bold; color: #303133; border-bottom: 1px solid #eee;">ğŸ“‚ ç§‘ç›®åˆ—è¡¨</div>
                            <div v-for="sub in subjects" :key="sub" class="subject-item" :class="{active: currentSubject === sub}" @click="selectSubject(sub)">
                                <span>{{ sub }}</span>
                                <el-icon class="del-subject-btn" @click.stop="removeSubject(sub)"><Delete /></el-icon>
                            </div>
                        </div>
                        <div class="repo-main">
                            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 5; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                                <span style="font-weight: bold; font-size: 18px;">{{ currentSubject }} é¢˜åº“</span>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 13px; color: #409EFF; font-weight: bold; background: #ecf5ff; padding: 5px 10px; border-radius: 4px;" v-if="selectedIds.length > 0">
                                        å·²é€‰: {{ selectionStats }}
                                    </span>
                                    <el-button type="danger" :disabled="selectedIds.length === 0" @click="openPreview">ğŸ›’ å»ç»„å· ({{ selectedIds.length }})</el-button>
                                    <el-button @click="loadQuestions" icon="Refresh" circle></el-button>
                                </div>
                            </div>
                            <el-table ref="questionTable" :data="dbQuestions" border stripe style="flex: 1; overflow: hidden" height="100%" class="no-select"
                                      @selection-change="handleSelection" @row-click="handleRowClick">
                                <el-table-column type="selection" width="55"></el-table-column>
                                <el-table-column prop="type" label="ç±»å‹" width="80">
                                    <template #default="scope"><el-tag size="small">{{ getTypeName(scope.row.type) }}</el-tag></template>
                                </el-table-column>
                                <el-table-column prop="title" label="é¢˜ç›®" show-overflow-tooltip></el-table-column>
                                <el-table-column prop="score" label="å½“å‰åˆ†" width="80"></el-table-column>
                                <el-table-column label="æ“ä½œ" width="150" align="center">
                                    <template #default="scope">
                                        <el-button size="small" @click.stop="openEdit(scope.row)">ç¼–è¾‘</el-button>
                                        <el-button size="small" type="danger" @click.stop="deleteQ(scope.row.id)">åˆ </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </div>
                </el-tab-pane>

                <el-tab-pane name="papers">
                    <template #label><span style="display: flex; align-items: center; gap:5px"><el-icon><Document /></el-icon> è¯•å·ç®¡ç†</span></template>
                    <div style="max-width: 1000px; margin: 0 auto;">
                        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold; font-size: 18px;">å·²å‘å¸ƒè¯•å·</span>
                            <el-button @click="loadPaperList" icon="Refresh" circle></el-button>
                        </div>

                        <el-table :data="paperList" border stripe style="width: 100%">
                            <el-table-column prop="id" label="ID" width="80" align="center"></el-table-column>
                            <el-table-column prop="title" label="è¯•å·æ ‡é¢˜"></el-table-column>
                            <el-table-column prop="totalScore" label="æ€»åˆ†" width="100" align="center"></el-table-column>
                            <el-table-column prop="duration" label="æ—¶é•¿" width="100" align="center">
                                <template #default="scope">{{ scope.row.duration }} åˆ†é’Ÿ</template>
                            </el-table-column>
                            <el-table-column prop="createTime" label="å‘å¸ƒæ—¶é—´" width="200" align="center">
                                <template #default="scope">{{ formatDate(scope.row.createTime) }}</template>
                            </el-table-column>
                            <el-table-column label="æ“ä½œ" width="120" align="center">
                                <template #default="scope">
                                    <el-popconfirm title="ç¡®å®šè¦åˆ é™¤è¿™å¼ è¯•å·å—ï¼Ÿ" @confirm="deletePaper(scope.row.id)">
                                        <template #reference>
                                            <el-button type="danger" size="small" icon="Delete">åˆ é™¤</el-button>
                                        </template>
                                    </el-popconfirm>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>

        <el-dialog v-model="previewVisible" title="ğŸ“œ è¯•å·é¢„è§ˆä¸å‘å¸ƒ" width="800px">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <span>è¯•å·æ ‡é¢˜ï¼š</span>
                <el-input v-model="finalPaperTitle" style="width: 300px;"></el-input>
                <div style="flex:1"></div>
                <el-button type="warning" @click="smartBalanceInPreview">âš¡ æ™ºèƒ½é…å¹³(100åˆ†)</el-button>
            </div>

            <div class="preview-list">
                <div v-for="(q, i) in previewQuestions" :key="q.id" class="preview-item">
                    <div style="flex: 1; margin-right: 10px;">
                        <el-tag size="small" style="margin-right: 5px;">{{ i+1 }}</el-tag>
                        <span style="font-weight: bold; font-size: 12px;">[{{ getTypeName(q.type) }}]</span>
                        {{ q.title }}
                    </div>
                    <div style="width: 80px;">
                        <el-input-number v-model="q.score" size="small" :min="1" style="width: 80px;"></el-input-number>
                    </div>
                </div>
            </div>

            <div style="margin-top: 15px; text-align: right; border-top: 1px solid #eee; padding-top: 10px;">
                <span style="margin-right: 20px; font-weight: bold; font-size: 16px;">
                    æ€»åˆ†: <span :style="{color: totalScore===100?'#67C23A':'#F56C6C'}">{{ totalScore }}</span> åˆ†
                </span>
                <el-button type="warning" icon="Document" @click="exportWordFromPreview">ğŸ“¥ å¯¼å‡º Word</el-button>
                <el-button type="primary" icon="Upload" @click="publishFinal">ğŸš€ çº¿ä¸Šå‘å¸ƒ</el-button>
            </div>
        </el-dialog>

        <el-dialog v-model="logVisible" title="AI ä»»åŠ¡æ‰§è¡Œä¸­" width="650px" :close-on-click-modal="false" :show-close="false" center style="background: transparent; box-shadow: none;">
            <div class="hologram-box">
                <div class="status-header">
                    <div class="spinner"></div>
                    <span style="font-weight: bold;">DeepSeek-V3 æ­£åœ¨ç”Ÿæˆæ•°æ®æµ...</span>
                </div>
                <div class="log-container" id="logBox">
                    <div v-for="(log, index) in logs" :key="index" class="log-line">
                        <span style="color: #8b949e; margin-right: 10px;">{{ new Date().toLocaleTimeString() }}</span>
                        <span v-html="log"></span>
                    </div>
                </div>
            </div>
            <div slot="footer" style="text-align: center; margin-top: 20px;">
                <el-button v-if="!loading" type="primary" @click="logVisible = false">å®Œæˆä»»åŠ¡ï¼ŒæŸ¥çœ‹ç»“æœ</el-button>
            </div>
        </el-dialog>

        <el-dialog v-model="editVisible" title="ä¿®æ”¹é¢˜ç›®" width="500px">
            <el-form :model="editForm" label-width="60px">
                <el-form-item label="é¢˜å¹²"><el-input v-model="editForm.title" type="textarea" :rows="3"></el-input></el-form-item>
                <el-form-item label="ç±»å‹">
                    <el-select v-model="editForm.type"><el-option label="å•é€‰" :value="1"></el-option><el-option label="å¤šé€‰" :value="2"></el-option><el-option label="åˆ¤æ–­" :value="3"></el-option><el-option label="å¡«ç©º" :value="4"></el-option><el-option label="ç®€ç­”" :value="5"></el-option></el-select>
                </el-form-item>
                <el-form-item label="åˆ†æ•°"><el-input-number v-model="editForm.score"></el-input-number></el-form-item>
                <el-form-item label="ç­”æ¡ˆ"><el-input v-model="editForm.answer"></el-input></el-form-item>
                <el-form-item label="è§£æ"><el-input v-model="editForm.analysis" type="textarea"></el-input></el-form-item>
            </el-form>
            <template #footer><el-button @click="editVisible = false">å–æ¶ˆ</el-button><el-button type="primary" @click="saveEdit">ä¿å­˜</el-button></template>
        </el-dialog>
    </div>
</div>

<script>
    const { createApp, ref, reactive, nextTick, computed, onMounted } = Vue;
    const { ElMessage, ElMessageBox } = ElementPlus;

    const app = createApp({
        setup() {
            const activeTab = ref('gen');
            const command = ref('');
            const difficulty = ref('ä¸­ç­‰');
            const paperTitle = ref('');
            const paper = ref([]);
            const logVisible = ref(false);
            const logs = ref([]);
            const loading = ref(false);
            const subjects = ref(['å…¨éƒ¨']);
            const currentSubject = ref('å…¨éƒ¨');
            const dbQuestions = ref([]);
            const selectedIds = ref([]); const selectedRows = ref([]);
            const editVisible = ref(false);
            const editForm = reactive({});

            // é¢„è§ˆç›¸å…³
            const previewVisible = ref(false);
            const previewQuestions = ref([]);
            const finalPaperTitle = ref('');
            const questionTable = ref(null);
            let lastSelectedIndex = -1;

            // ğŸ”¥ğŸ”¥ æ–°å¢ï¼šè¯•å·åˆ—è¡¨æ•°æ® ğŸ”¥ğŸ”¥
            const paperList = ref([]);

            // ç»Ÿè®¡
            const selectionStats = computed(() => {
                const counts = {1:0, 2:0, 3:0, 4:0, 5:0};
                selectedRows.value.forEach(q => counts[q.type] = (counts[q.type]||0) + 1);
                let str = [];
                if(counts[1]) str.push(`å•é€‰${counts[1]}`);
                if(counts[2]) str.push(`å¤šé€‰${counts[2]}`);
                if(counts[3]) str.push(`åˆ¤æ–­${counts[3]}`);
                if(counts[4]) str.push(`å¡«ç©º${counts[4]}`);
                if(counts[5]) str.push(`å¤§é¢˜${counts[5]}`);
                return str.join(' + ');
            });

            // æ€»åˆ†è®¡ç®—
            const totalScore = computed(() => previewQuestions.value.reduce((sum, q) => sum + (q.score || 0), 0));

            const generate = () => {
                if(!command.value) return ElMessage.warning('è¯·è¾“å…¥æŒ‡ä»¤');
                loading.value = true; logVisible.value = true;
                logs.value = ["System Init... è¿æ¥ç¥ç»ä¸­æ¢..."];
                paper.value = [];
                const eventSource = new EventSource(`/api/teacher/paper/stream-gen?topic=${encodeURIComponent(command.value)}&difficulty=${encodeURIComponent(difficulty.value)}`);
                eventSource.addEventListener('log', (e) => { logs.value.push(e.data); nextTick(() => { const box = document.getElementById('logBox'); if(box) box.scrollTop = box.scrollHeight; }); });
                eventSource.addEventListener('complete', (e) => { const data = JSON.parse(e.data); paper.value = data.questions; paperTitle.value = data.aiTitle; logs.value.push("<span style='color:#67C23A'>âœ… ä»»åŠ¡å®Œæˆï¼</span>"); loading.value = false; eventSource.close(); });
                eventSource.addEventListener('error', (e) => { logs.value.push("âŒ é”™è¯¯: " + e.data); loading.value = false; eventSource.close(); });
                eventSource.onerror = () => { if(loading.value) { logs.value.push("âš ï¸ è¿æ¥ä¸­æ–­"); loading.value = false; eventSource.close(); } };
            };

            const publishAI = () => { axios.post('/api/teacher/paper/publish', { title: paperTitle.value, questions: paper.value }).then(() => { ElMessage.success('å·²å…¥åº“'); loadSubjects(); activeTab.value = 'repo'; loadPaperList(); }); };

            // å¯¼å‡º Word (å¿«æ·æ–¹æ³•)
            const doExport = (title, qs) => {
                ElMessage.info('ç”Ÿæˆæ–‡æ¡£ä¸­...');
                axios.post('/api/export/word', { title: title, questions: qs }, { responseType: 'blob' })
                    .then(res => {
                        const url = window.URL.createObjectURL(new Blob([res.data]));
                        const link = document.createElement('a'); link.href = url;
                        link.setAttribute('download', title + '.docx');
                        document.body.appendChild(link); link.click(); document.body.removeChild(link);
                        ElMessage.success('å¯¼å‡ºæˆåŠŸ');
                    }).catch(() => ElMessage.error('å¯¼å‡ºå¤±è´¥'));
            }

            const loadSubjects = () => { axios.get('/api/teacher/subject/list').then(r => subjects.value = ['å…¨éƒ¨', ...r.data.data]); };
            const removeSubject = (sub) => { if(sub==='å…¨éƒ¨')return; ElMessageBox.confirm(`ç¡®è®¤åˆ é™¤ã€${sub}ã€‘ï¼Ÿ`).then(() => { axios.post(`/api/teacher/subject/delete?subject=${encodeURIComponent(sub)}`).then(() => { ElMessage.success('å·²åˆ é™¤'); loadSubjects(); loadQuestions(); }); }); };
            const selectSubject = (sub) => { currentSubject.value = sub; loadQuestions(); };
            const loadQuestions = () => { axios.get(`/api/teacher/question/list?subject=${currentSubject.value}`).then(r => dbQuestions.value = r.data.data); };
            const openEdit = (row) => { Object.assign(editForm, JSON.parse(JSON.stringify(row))); editVisible.value = true; };
            const saveEdit = () => { axios.post('/api/teacher/question/update', editForm).then(() => { ElMessage.success('ä¿®æ”¹æˆåŠŸ'); editVisible.value = false; loadQuestions(); }); };
            const deleteQ = (id) => { ElMessageBox.confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ').then(() => { axios.post(`/api/teacher/question/delete?id=${id}`).then(() => { ElMessage.success('å·²åˆ '); loadQuestions(); }); }); };
            const removeAiQuestion = (index) => { paper.value.splice(index, 1); };

            const handleSelection = (val) => { selectedRows.value = val; selectedIds.value = val.map(q => q.id); };

            // Shift è¿é€‰é€»è¾‘
            const handleRowClick = (row, column, event) => {
                const index = dbQuestions.value.indexOf(row);
                if (event.shiftKey && lastSelectedIndex !== -1) {
                    const start = Math.min(lastSelectedIndex, index);
                    const end = Math.max(lastSelectedIndex, index);
                    const rowsToSelect = dbQuestions.value.slice(start, end + 1);
                    rowsToSelect.forEach(r => { questionTable.value.toggleRowSelection(r, true); });
                } else {
                    questionTable.value.toggleRowSelection(row);
                }
                lastSelectedIndex = index;
            };

            const openPreview = () => {
                previewQuestions.value = JSON.parse(JSON.stringify(selectedRows.value));
                finalPaperTitle.value = currentSubject.value + "æœŸæœ«è¯•å·";
                previewVisible.value = true;
            };

            const smartBalanceInPreview = () => {
                const qs = previewQuestions.value;
                if (qs.length === 0) return;
                const bigs = qs.filter(q => q.type === 5);
                const smalls = qs.filter(q => q.type !== 5);
                const totalUnits = (bigs.length * 3) + (smalls.length * 1);
                if (totalUnits === 0) return;
                const unitValue = 100 / totalUnits;
                let currentTotal = 0;
                bigs.forEach(q => { const s = Math.floor(unitValue * 3); q.score = s > 0 ? s : 1; currentTotal += q.score; });
                smalls.forEach(q => { const s = Math.floor(unitValue * 1); q.score = s > 0 ? s : 1; currentTotal += q.score; });
                if (currentTotal < 100) qs[qs.length - 1].score += (100 - currentTotal);
                else if (currentTotal > 100) qs[qs.length - 1].score -= (currentTotal - 100);
                ElMessage.success('âœ… å·²æ™ºèƒ½é…åˆ†');
            };

            const exportWordFromPreview = () => { doExport(finalPaperTitle.value, previewQuestions.value); };
            const publishFinal = () => {
                axios.post('/api/teacher/paper/publish', { title: finalPaperTitle.value, questions: previewQuestions.value }).then(() => {
                    ElMessage.success('å‘å¸ƒæˆåŠŸ'); previewVisible.value = false; loadSubjects(); loadPaperList();
                });
            };

            // ğŸ”¥ğŸ”¥ æ–°å¢ï¼šåŠ è½½è¯•å·åˆ—è¡¨ ğŸ”¥ğŸ”¥
            const loadPaperList = () => {
                axios.get('/api/teacher/paper/list').then(res => {
                    if (res.data.code === 200) {
                        paperList.value = res.data.data;
                    }
                });
            };

            // ğŸ”¥ğŸ”¥ æ–°å¢ï¼šåˆ é™¤è¯•å· ğŸ”¥ğŸ”¥
            const deletePaper = (id) => {
                axios.post('/api/teacher/paper/delete?id=' + id).then(res => {
                    if (res.data.code === 200) {
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        loadPaperList();
                    }
                });
            };

            const formatDate = (str) => {
                if(!str) return '';
                return str.replace('T', ' ').substring(0, 16);
            };

            const getTypeName = (t) => ({1:'å•é€‰',2:'å¤šé€‰',3:'åˆ¤æ–­',4:'å¡«ç©º',5:'ç®€ç­”'}[t] || 'å…¶ä»–');
            const getTypeTag = (t) => t===5 ? 'danger' : (t===4?'warning':'');
            const logout = () => location.href = 'login.html';

            onMounted(() => {
                loadSubjects();
                loadQuestions();
                loadPaperList(); // è‡ªåŠ¨åŠ è½½è¯•å·
            });

            return { activeTab, command, difficulty, paperTitle, paper, logVisible, logs, loading, subjects, currentSubject, dbQuestions, selectedIds, editVisible, editForm, generate, publishAI, removeSubject, selectSubject, loadQuestions, openEdit, saveEdit, deleteQ, removeAiQuestion, handleSelection, publishSelection:openPreview, getTypeName, getTypeTag, logout,
                questionTable, handleRowClick, selectionStats,
                previewVisible, previewQuestions, finalPaperTitle, openPreview, smartBalanceInPreview, totalScore, exportWordFromPreview, publishFinal,
                paperList, loadPaperList, deletePaper, formatDate
            };
        }
    });
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) app.component(key, component);
    app.use(ElementPlus);
    app.mount('#app');
</script>
</body>
</html>